<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduAI Principal Dashboard - Student Assessment</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons (for aesthetic icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Chart.js (for data visualization) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom Tailwind Configuration */
        :root {
            font-family: 'Inter', sans-serif;
        }

        .text-gradient {
            background: linear-gradient(to right, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .gradient-main {
            background-image: linear-gradient(to right, #6366f1, #a855f7);
        }

        .main-shadow {
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.2), 0 4px 6px -2px rgba(99, 102, 241, 0.1);
        }

        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Custom styles for assessment cards */
        .assessment-card {
            transition: all 0.3s ease;
        }

        .assessment-card:hover {
            transform: translateY(-5px);
        }

        .progress-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .baseline-color {
            background-color: #6366f1;
        }

        .midline-color {
            background-color: #8b5cf6;
        }

        .endline-color {
            background-color: #a855f7;
        }

        .improvement-positive {
            color: #10b981;
        }

        .improvement-negative {
            color: #ef4444;
        }

        /* Fix for dynamic color classes */
        .bg-indigo-500-20 {
            background-color: rgba(99, 102, 241, 0.2);
        }

        .bg-purple-500-20 {
            background-color: rgba(168, 85, 247, 0.2);
        }

        .bg-green-500-20 {
            background-color: rgba(16, 185, 129, 0.2);
        }

        .bg-yellow-500-20 {
            background-color: rgba(245, 158, 11, 0.2);
        }

        .bg-indigo-900-50 {
            background-color: rgba(49, 46, 129, 0.5);
        }

        /* Mobile menu styles */
        .mobile-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 40;
        }

        .mobile-menu.open {
            transform: translateX(0);
        }

        /* Desktop sidebar styles */
        .desktop-sidebar {
            transform: translateX(0);
            transition: transform 0.3s ease;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 1023px) {
            .mobile-hidden {
                display: none;
            }

            .mobile-full {
                width: 100%;
            }

            .mobile-stack {
                flex-direction: column;
            }
        }

        /* Overlay for mobile menu */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
        }

        .mobile-overlay.open {
            display: block;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen">

    <!-- Mobile Menu Button -->
    <div class="lg:hidden fixed top-4 left-4 z-20">
        <button id="mobile-menu-button" class="p-2 rounded-lg bg-gray-800 text-white shadow-lg">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- Mobile Overlay -->
    <div id="mobile-overlay" class="mobile-overlay"></div>

    <div id="app" class="flex flex-col lg:flex-row h-full">

        <!-- Sidebar / Navigation - FIXED: Added desktop-sidebar class for desktop view -->
        <aside id="sidebar"
            class="mobile-menu desktop-sidebar bg-gray-800 lg:w-64 p-6 flex flex-col shadow-2xl z-10 transition-all duration-300 fixed lg:relative h-full lg:h-auto">
            <div class="mb-10 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="text-3xl font-extrabold text-gradient">EduAI</span>
                    <span class="text-lg font-light text-gray-400 mobile-hidden">Principal</span>
                </div>
                <button id="close-mobile-menu" class="lg:hidden p-2 rounded-lg bg-gray-700 text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <nav class="flex lg:flex-col space-x-4 lg:space-x-0 lg:space-y-3 overflow-x-auto pb-2">
                <button onclick="changeView('dashboard')" id="nav-dashboard"
                    class="nav-item flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-700 transition duration-150">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="text-sm font-medium whitespace-nowrap">Dashboard</span>
                </button>
                <button onclick="changeView('students')" id="nav-students"
                    class="nav-item flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-700 transition duration-150">
                    <i data-lucide="graduation-cap" class="w-5 h-5"></i>
                    <span class="text-sm font-medium whitespace-nowrap">Students</span>
                </button>
                <button onclick="changeView('staff')" id="nav-staff"
                    class="nav-item flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-700 transition duration-150">
                    <i data-lucide="users-round" class="w-5 h-5"></i>
                    <span class="text-sm font-medium whitespace-nowrap">Staff</span>
                </button>
                <button onclick="changeView('progress')" id="nav-progress"
                    class="nav-item flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-700 transition duration-150">
                    <i data-lucide="trending-up" class="w-5 h-5"></i>
                    <span class="text-sm font-medium whitespace-nowrap">Progress & AI</span>
                </button>
                <button onclick="changeView('assessments')" id="nav-assessments"
                    class="nav-item flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-700 transition duration-150">
                    <i data-lucide="clipboard-check" class="w-5 h-5"></i>
                    <span class="text-sm font-medium whitespace-nowrap">Assessments</span>
                </button>
            </nav>

            <div class="mt-auto pt-6 border-t border-gray-700">
                <p class="text-xs text-gray-500">Database: <span id="db-type-info"
                        class="font-mono text-xs text-purple-400">Local Storage</span></p>
                <p class="text-xs text-gray-500 mt-1">Status: <span class="text-green-500">Online</span></p>
                <button onclick="resetData()" class="mt-4 w-full text-xs text-red-400 hover:text-red-300 transition">
                    Reset All Data
                </button>
            </div>
        </aside>

        <!-- Main Content Area - FIXED: Updated margin for desktop view -->
        <main id="content-container" class="flex-1 p-4 sm:p-8 overflow-y-auto lg:ml-0">
            <!-- Content will be rendered here by JavaScript -->
            <h1 class="text-3xl font-bold mb-6 text-gray-200" id="page-title">Loading Dashboard...</h1>
            <div id="view-content" class="min-h-[500px]">
                <div class="flex justify-center items-center h-full">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Global Message Modal (Replaces alert/confirm) -->
    <div id="message-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex justify-center items-center p-4">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl main-shadow max-w-sm w-full border border-gray-700">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-indigo-400"></h3>
            <p id="modal-body" class="text-gray-300 mb-6 text-sm"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn"
                    class="hidden px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-lg hover:bg-gray-600 transition">Cancel</button>
                <button id="modal-confirm-btn"
                    class="px-4 py-2 text-sm font-medium text-white gradient-main rounded-lg hover:opacity-90 transition">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize app state with local storage persistence
        let appState = {
            currentView: 'dashboard',
            stats: {
                total_students: 0,
                total_staff: 0,
                attendance_rate: 0,
                academic_performance: 0,
                last_updated: new Date().toISOString()
            },
            students: [],
            staff: [],
            progress: {
                overview: {},
                chart: null,
                subjects: []
            },
            assessments: {
                baseline: [],
                midline: [],
                endline: [],
                studentProgress: []
            }
        };

        // Initialize from localStorage if available
        function initializeAppState() {
            const savedState = localStorage.getItem('eduai-dashboard-data');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                appState.students = parsedState.students || [];
                appState.staff = parsedState.staff || [];
                appState.assessments = parsedState.assessments || {
                    baseline: [],
                    midline: [],
                    endline: [],
                    studentProgress: []
                };

                // Update stats based on actual data
                updateStats();
            } else {
                // Load initial mock data
                loadInitialData();
            }
        }

        // Save state to localStorage
        function saveAppState() {
            const stateToSave = {
                students: appState.students,
                staff: appState.staff,
                assessments: appState.assessments
            };
            localStorage.setItem('eduai-dashboard-data', JSON.stringify(stateToSave));
            updateStats();
        }

        // Reset all data
        function resetData() {
            showModal("Reset Data", "Are you sure you want to reset all data? This cannot be undone.", true)
                .then(confirmed => {
                    if (confirmed) {
                        localStorage.removeItem('eduai-dashboard-data');
                        initializeAppState();
                        loadData();
                        showModal("Success", "All data has been reset to initial values.");
                    }
                });
        }

        // Update stats based on current data
        function updateStats() {
            appState.stats.total_students = appState.students.length;
            appState.stats.total_staff = appState.staff.length;

            // Calculate attendance rate (mock calculation)
            if (appState.students.length > 0) {
                const totalAttendance = appState.students.reduce((sum, student) => sum + (student.attendance || 0), 0);
                appState.stats.attendance_rate = totalAttendance / appState.students.length;
            }

            // Calculate academic performance (mock calculation)
            if (appState.students.length > 0) {
                const totalScores = appState.students.reduce((sum, student) => sum + (student.overall_score || 0), 0);
                appState.stats.academic_performance = totalScores / appState.students.length;
            }

            appState.stats.last_updated = new Date().toISOString();
        }

        // Load initial mock data
        function loadInitialData() {
            // Initial students
            appState.students = [
                { id: 1, name: "Emma Johnson", grade: 10, overall_score: 92, attendance: 96 },
                { id: 2, name: "Noah Williams", grade: 9, overall_score: 85, attendance: 92 },
                { id: 3, name: "Olivia Brown", grade: 11, overall_score: 78, attendance: 88 },
                { id: 4, name: "Liam Jones", grade: 10, overall_score: 91, attendance: 95 },
                { id: 5, name: "Ava Garcia", grade: 9, overall_score: 87, attendance: 90 }
            ];

            // Initial staff
            appState.staff = [
                { id: 1, name: "Dr. Sarah Mitchell", role: "Math Teacher", department: "Mathematics" },
                { id: 2, name: "Mr. James Wilson", role: "Science Teacher", department: "Science" },
                { id: 3, name: "Ms. Emily Chen", role: "English Teacher", department: "Language Arts" },
                { id: 4, name: "Dr. Robert Taylor", role: "History Teacher", department: "Social Studies" },
                { id: 5, name: "Mrs. Lisa Anderson", role: "Art Teacher", department: "Fine Arts" }
            ];

            // Initial assessments
            appState.assessments.studentProgress = [
                { id: 1, name: "Emma Johnson", grade: 10, baseline_score: 85, midline_score: 89, endline_score: 92 },
                { id: 2, name: "Noah Williams", grade: 9, baseline_score: 78, midline_score: 82, endline_score: 85 },
                { id: 3, name: "Olivia Brown", grade: 11, baseline_score: 72, midline_score: 75, endline_score: 78 },
                { id: 4, name: "Liam Jones", grade: 10, baseline_score: 88, midline_score: 90, endline_score: 91 },
                { id: 5, name: "Ava Garcia", grade: 9, baseline_score: 80, midline_score: 84, endline_score: 87 }
            ];

            updateStats();
            saveAppState();
        }

        const viewContent = document.getElementById('view-content');
        const pageTitle = document.getElementById('page-title');

        // =====================================================================
        // 1. UTILITIES (Modal/Messaging)
        // =====================================================================
        let resolveModalPromise = null;

        function showModal(title, body, isConfirm = false) {
            return new Promise((resolve) => {
                resolveModalPromise = resolve;

                const modal = document.getElementById('message-modal');
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-body').textContent = body;

                const okBtn = document.getElementById('modal-confirm-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');

                if (isConfirm) {
                    okBtn.textContent = 'Confirm';
                    okBtn.onclick = () => { closeModal(); resolve(true); };
                    cancelBtn.classList.remove('hidden');
                    cancelBtn.onclick = () => { closeModal(); resolve(false); };
                } else {
                    okBtn.textContent = 'OK';
                    okBtn.onclick = () => { closeModal(); resolve(true); };
                    cancelBtn.classList.add('hidden');
                }

                modal.classList.remove('hidden');
            });
        }

        function closeModal() {
            document.getElementById('message-modal').classList.add('hidden');
            if (resolveModalPromise) {
                resolveModalPromise(false);
                resolveModalPromise = null;
            }
        }

        // =====================================================================
        // 2. MOBILE MENU HANDLING - FIXED
        // =====================================================================

        function setupMobileMenu() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const closeMobileMenuButton = document.getElementById('close-mobile-menu');
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobile-overlay');

            function openMobileMenu() {
                sidebar.classList.add('open');
                mobileOverlay.classList.add('open');
                document.body.style.overflow = 'hidden'; // Prevent scrolling when menu is open
            }

            function closeMobileMenu() {
                sidebar.classList.remove('open');
                mobileOverlay.classList.remove('open');
                document.body.style.overflow = ''; // Restore scrolling
            }

            mobileMenuButton.addEventListener('click', openMobileMenu);
            closeMobileMenuButton.addEventListener('click', closeMobileMenu);

            // Close menu when clicking on overlay
            mobileOverlay.addEventListener('click', closeMobileMenu);

            // Close menu when clicking on a nav item on mobile
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth < 1024) {
                        closeMobileMenu();
                    }
                });
            });

            // Close menu when window is resized to desktop size
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 1024) {
                    closeMobileMenu();
                }
            });
        }

        // =====================================================================
        // 3. CORE LOGIC
        // =====================================================================

        async function loadData() {
            viewContent.innerHTML = '<div class="flex justify-center items-center h-full min-h-[500px]"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div></div>';

            // Load all necessary data for the current view
            switch (appState.currentView) {
                case 'dashboard':
                    appState.progress.overview = await fetchMockData('/progress/overview');
                    appState.progress.chart = await fetchMockData('/progress/chart');
                    break;
                case 'students':
                    // Students are already loaded from localStorage
                    break;
                case 'staff':
                    // Staff are already loaded from localStorage
                    break;
                case 'progress':
                    appState.progress.subjects = await fetchMockData('/progress/subjects');
                    appState.progress.chart = await fetchMockData('/progress/chart');
                    appState.progress.overview = await fetchMockData('/progress/overview');
                    break;
                case 'assessments':
                    appState.assessments.baseline = await fetchMockData('/assessments/baseline');
                    appState.assessments.midline = await fetchMockData('/assessments/midline');
                    appState.assessments.endline = await fetchMockData('/assessments/endline');
                    // Student progress is already loaded from localStorage
                    break;
            }
            renderApp();
        }

        // Mock data function for demo purposes
        async function fetchMockData(endpoint) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 300));

            switch (endpoint) {
                case '/progress/overview':
                    return {
                        average_grade: 78.5,
                        completion_rate: 92.3,
                        top_performer: appState.students.length > 0 ?
                            appState.students.reduce((prev, current) =>
                                (prev.overall_score > current.overall_score) ? prev : current).name : "N/A",
                        improvement_rate: 12.7
                    };
                case '/progress/chart':
                    return {
                        labels: ['Math', 'Science', 'English', 'History', 'Art'],
                        datasets: [{
                            label: 'Average Score',
                            data: [85, 78, 82, 75, 88],
                            backgroundColor: [
                                'rgba(99, 102, 241, 0.7)',
                                'rgba(139, 92, 246, 0.7)',
                                'rgba(168, 85, 247, 0.7)',
                                'rgba(217, 70, 239, 0.7)',
                                'rgba(236, 72, 153, 0.7)'
                            ],
                            borderColor: [
                                'rgb(99, 102, 241)',
                                'rgb(139, 92, 246)',
                                'rgb(168, 85, 247)',
                                'rgb(217, 70, 239)',
                                'rgb(236, 72, 153)'
                            ],
                            borderWidth: 1
                        }]
                    };
                case '/progress/subjects':
                    return [
                        { name: "Mathematics", teacher: "Dr. Sarah Mitchell", average: 85.2, improvement: 8.5 },
                        { name: "Science", teacher: "Mr. James Wilson", average: 78.7, improvement: 12.3 },
                        { name: "English", teacher: "Ms. Emily Chen", average: 82.1, improvement: 5.2 },
                        { name: "History", teacher: "Dr. Robert Taylor", average: 75.8, improvement: 3.7 },
                        { name: "Art", teacher: "Mrs. Lisa Anderson", average: 88.4, improvement: 15.1 }
                    ];
                case '/assessments/baseline':
                    return appState.students.map(student => ({
                        id: student.id,
                        name: student.name,
                        completed: Math.random() > 0.2 // 80% completion rate
                    }));
                case '/assessments/midline':
                    return appState.students.map(student => ({
                        id: student.id,
                        name: student.name,
                        completed: Math.random() > 0.3 // 70% completion rate
                    }));
                case '/assessments/endline':
                    return appState.students.map(student => ({
                        id: student.id,
                        name: student.name,
                        completed: Math.random() > 0.15 // 85% completion rate
                    }));
                default:
                    return {};
            }
        }

        function changeView(newView) {
            appState.currentView = newView;

            // Update navigation active state
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('bg-indigo-700', 'text-white', 'main-shadow');
            });
            document.getElementById(`nav-${newView}`).classList.add('bg-indigo-700', 'text-white', 'main-shadow');

            const titles = {
                'dashboard': 'Dashboard Overview',
                'students': 'Student Management',
                'staff': 'Staff Directory',
                'progress': 'Academic Progress',
                'assessments': 'Assessment Results'
            };

            pageTitle.textContent = titles[newView] || newView.charAt(0).toUpperCase() + newView.slice(1);
            loadData();
        }

        function renderApp() {
            viewContent.innerHTML = ''; // Clear previous content

            switch (appState.currentView) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'students':
                    renderStudents();
                    break;
                case 'staff':
                    renderStaff();
                    break;
                case 'progress':
                    renderProgress();
                    break;
                case 'assessments':
                    renderAssessments();
                    break;
            }
            // Re-render Lucide icons after innerHTML update
            lucide.createIcons();
        }

        // =====================================================================
        // 4. VIEW RENDERING FUNCTIONS
        // =====================================================================

        function renderCard(title, value, icon, color) {
            return `
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 transition duration-300 hover:scale-[1.01] hover:shadow-indigo-900/50">
                    <div class="flex items-center justify-between">
                        <div class="text-sm font-medium text-gray-400">${title}</div>
                        <i data-lucide="${icon}" class="w-6 h-6 text-${color}-400"></i>
                    </div>
                    <div class="mt-4 text-3xl font-extrabold text-white">${value}</div>
                </div>
            `;
        }

        function renderDashboard() {
            const stats = appState.stats || {};
            const overview = appState.progress.overview || {};
            const chartData = appState.progress.chart;

            viewContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
                    ${renderCard("Total Students", stats.total_students || 0, "users", "indigo")}
                    ${renderCard("Total Staff", stats.total_staff || 0, "briefcase", "purple")}
                    ${renderCard("Attendance Rate", (stats.attendance_rate || 0).toFixed(1) + "%", "check-circle", "green")}
                    ${renderCard("Academic Performance", (stats.academic_performance || 0).toFixed(1) + "%", "bar-chart-2", "yellow")}
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-4 text-gray-200">Subject Average Scores</h3>
                        <div class="h-64 md:h-80">
                            <canvas id="average-scores-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-4 text-gray-200">AI Insights Overview</h3>
                        <div class="space-y-4">
                            ${renderInsight("Average Grade", (overview.average_grade || 0).toFixed(1) + "%", "A+", "indigo")}
                            ${renderInsight("Completion Rate", (overview.completion_rate || 0).toFixed(1) + "%", "Task Check", "green")}
                            ${renderInsight("Top Performer", overview.top_performer || "N/A", "Star Student", "yellow")}
                            ${renderInsight("Improvement Rate", (overview.improvement_rate || 0).toFixed(1) + "%", "Growth", "purple")}
                        </div>
                        <p class="text-xs text-gray-500 mt-6">Last Updated: ${new Date(stats.last_updated || Date.now()).toLocaleString()}</p>
                    </div>
                </div>
            `;

            if (chartData) {
                initializeChart(chartData);
            }
        }

        function renderInsight(title, value, description, color) {
            return `
                <div class="flex items-center space-x-4 p-3 bg-gray-700/50 rounded-lg">
                    <div class="w-10 h-10 flex items-center justify-center bg-${color}-500-20 rounded-full">
                        <i data-lucide="zap" class="w-5 h-5 text-${color}-400"></i>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-${color}-300">${value}</div>
                        <div class="text-sm text-gray-400">${title}</div>
                    </div>
                </div>
            `;
        }

        function renderStudents() {
            const students = appState.students || [];

            viewContent.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <p class="text-sm text-gray-400">${students.length} students currently enrolled.</p>
                    <button onclick="showAddForm('student')" class="flex items-center space-x-2 px-4 py-2 text-sm font-medium text-white gradient-main rounded-xl hover:opacity-90 transition main-shadow w-full md:w-auto justify-center">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>Add Student</span>
                    </button>
                </div>
                ${renderAddStudentForm()}
                <div class="bg-gray-800 rounded-xl shadow-lg overflow-x-auto border border-gray-700">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID</th>
                                <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                                <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Grade</th>
                                <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Score</th>
                                <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Attendance</th>
                                <th class="px-4 md:px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            ${students.length > 0 ? students.map(s => `
                                <tr class="hover:bg-gray-700/50 transition">
                                    <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-300">${s.id}</td>
                                    <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-gray-200">${s.name}</td>
                                    <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-gray-400">${s.grade}</td>
                                    <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-white font-bold">${s.overall_score}</td>
                                    <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-green-400">${s.attendance}%</td>
                                    <td class="px-4 md:px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button onclick="handleDelete('student', ${s.id})" class="text-red-400 hover:text-red-500 transition p-1 rounded-full hover:bg-gray-700" title="Delete Student">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="6" class="px-4 md:px-6 py-8 text-center text-gray-400">
                                        <div class="flex flex-col items-center justify-center">
                                            <i data-lucide="users" class="w-12 h-12 mb-2 text-gray-500"></i>
                                            <p>No students found. Add your first student to get started.</p>
                                        </div>
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderStaff() {
            const staff = appState.staff || [];

            viewContent.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <p class="text-sm text-gray-400">${staff.length} staff members currently employed.</p>
                    <button onclick="showAddForm('staff')" class="flex items-center space-x-2 px-4 py-2 text-sm font-medium text-white gradient-main rounded-xl hover:opacity-90 transition main-shadow w-full md:w-auto justify-center">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>Add Staff</span>
                    </button>
                </div>
                ${renderAddStaffForm()}
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${staff.length > 0 ? staff.map(s => `
                        <div class="flex justify-between items-center p-4 bg-gray-800 rounded-xl shadow-lg border border-gray-700 transition duration-150 hover:border-purple-500">
                            <div>
                                <div class="font-semibold text-lg text-white">${s.name}</div>
                                <div class="text-sm text-purple-400">${s.role}</div>
                                <div class="text-xs text-gray-400">${s.department}</div>
                            </div>
                            <button onclick="handleDelete('staff', ${s.id})" class="text-red-400 hover:text-red-500 transition p-2 rounded-full hover:bg-gray-700" title="Delete Staff">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    `).join('') : `
                        <div class="col-span-3 flex flex-col items-center justify-center p-8 bg-gray-800 rounded-xl border border-gray-700">
                            <i data-lucide="user-plus" class="w-16 h-16 mb-4 text-gray-500"></i>
                            <p class="text-gray-400 text-center">No staff members found. Add your first staff member to get started.</p>
                        </div>
                    `}
                </div>
            `;
        }

        function renderProgress() {
            const subjects = appState.progress.subjects || [];
            const chartData = appState.progress.chart;

            viewContent.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4 text-indigo-400">Academic Progress Analysis</h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-4 text-gray-200">Overall Score Distribution</h3>
                        <div class="h-64 md:h-80">
                            <canvas id="progress-chart-view"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-4 text-gray-200">AI-Powered Improvement Focus</h3>
                        <p class="text-gray-400 mb-4 text-sm">Identifying areas of highest and lowest recent improvement across subjects.</p>
                        <ul class="space-y-3">
                            ${subjects.sort((a, b) => b.improvement - a.improvement).map(s => `
                                <li class="flex justify-between items-center p-3 rounded-lg bg-gray-700/50 border-l-4 ${s.improvement > 0 ? 'border-green-500' : 'border-red-500'}">
                                    <div class="flex flex-col">
                                        <span class="font-medium text-lg text-white">${s.name}</span>
                                        <span class="text-xs text-gray-400">Teacher: ${s.teacher}</span>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-lg font-bold ${s.improvement > 0 ? 'text-green-400' : 'text-red-400'}">${s.improvement.toFixed(1)}%</span>
                                        <span class="text-xs text-gray-500 block">Avg: ${s.average.toFixed(1)}%</span>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;
            if (chartData) {
                initializeChart(chartData, 'progress-chart-view');
            }
        }

        function renderAssessments() {
            const baseline = appState.assessments.baseline || [];
            const midline = appState.assessments.midline || [];
            const endline = appState.assessments.endline || [];
            const studentProgress = appState.assessments.studentProgress || [];

            viewContent.innerHTML = `
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-4 text-indigo-400">Student Assessment Dashboard</h2>
                    <p class="text-gray-400 mb-6">Track student progress across baseline, midline, and endline assessments to measure the impact of AI-empowered education.</p>
                    
                    <!-- Principal Recommendations Section -->
                    <div class="bg-gradient-to-r from-indigo-800 to-purple-800 p-4 md:p-6 rounded-xl shadow-lg mb-6 md:mb-8 border border-indigo-600">
                        <h3 class="text-xl font-bold mb-4 text-white flex items-center">
                            <i data-lucide="lightbulb" class="w-6 h-6 mr-2 text-yellow-400"></i>
                            Principal's Recommendations
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-indigo-900-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-white mb-2">Focus on High-Impact Interventions</h4>
                                <p class="text-sm text-indigo-200">Use AI insights to identify students who would benefit most from targeted interventions.</p>
                            </div>
                            <div class="bg-indigo-900-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-white mb-2">Leverage Positive Trends</h4>
                                <p class="text-sm text-indigo-200">Replicate successful teaching strategies from subjects showing the most improvement.</p>
                            </div>
                            <div class="bg-indigo-900-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-white mb-2">Address Learning Gaps</h4>
                                <p class="text-sm text-indigo-200">Focus resources on subjects where students show minimal improvement between assessments.</p>
                            </div>
                            <div class="bg-indigo-900-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-white mb-2">Professional Development</h4>
                                <p class="text-sm text-indigo-200">Use assessment data to identify areas where teachers could benefit from additional training.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Assessment Overview Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-6 md:mb-8">
                        <div class="bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg border border-indigo-700 assessment-card">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-indigo-300">Baseline Assessment</h3>
                                <i data-lucide="clipboard-list" class="w-8 h-8 text-indigo-400"></i>
                            </div>
                            <div class="text-3xl font-bold text-white mb-2">${baseline.length}</div>
                            <p class="text-sm text-gray-400">Students assessed at program start</p>
                            <div class="mt-4">
                                <div class="flex justify-between text-xs text-gray-400 mb-1">
                                    <span>Completion</span>
                                    <span>${baseline.filter(s => s.completed).length}/${baseline.length}</span>
                                </div>
                                <div class="progress-bar bg-gray-700">
                                    <div class="baseline-color h-full" style="width: ${(baseline.filter(s => s.completed).length / baseline.length) * 100 || 0}%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg border border-purple-700 assessment-card">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-purple-300">Midline Assessment</h3>
                                <i data-lucide="clipboard-check" class="w-8 h-8 text-purple-400"></i>
                            </div>
                            <div class="text-3xl font-bold text-white mb-2">${midline.length}</div>
                            <p class="text-sm text-gray-400">Students assessed mid-program</p>
                            <div class="mt-4">
                                <div class="flex justify-between text-xs text-gray-400 mb-1">
                                    <span>Completion</span>
                                    <span>${midline.filter(s => s.completed).length}/${midline.length}</span>
                                </div>
                                <div class="progress-bar bg-gray-700">
                                    <div class="midline-color h-full" style="width: ${(midline.filter(s => s.completed).length / midline.length) * 100 || 0}%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg border border-pink-700 assessment-card">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-pink-300">Endline Assessment</h3>
                                <i data-lucide="award" class="w-8 h-8 text-pink-400"></i>
                            </div>
                            <div class="text-3xl font-bold text-white mb-2">${endline.length}</div>
                            <p class="text-sm text-gray-400">Students assessed at program end</p>
                            <div class="mt-4">
                                <div class="flex justify-between text-xs text-gray-400 mb-1">
                                    <span>Completion</span>
                                    <span>${endline.filter(s => s.completed).length}/${endline.length}</span>
                                </div>
                                <div class="progress-bar bg-gray-700">
                                    <div class="endline-color h-full" style="width: ${(endline.filter(s => s.completed).length / endline.length) * 100 || 0}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Student Progress Visualization -->
                    <div class="bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg border border-gray-700 mb-6 md:mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-gray-200">Student Progress Over Time</h3>
                        <div class="h-64 md:h-80">
                            <canvas id="student-progress-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Detailed Student Progress Table -->
                    <div class="bg-gray-800 rounded-xl shadow-lg overflow-x-auto border border-gray-700">
                        <h3 class="text-xl font-semibold p-4 md:p-6 text-gray-200 border-b border-gray-700">Individual Student Progress</h3>
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Student</th>
                                    <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Baseline</th>
                                    <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Midline</th>
                                    <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Endline</th>
                                    <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Improvement</th>
                                    <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">AI Recommendations</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                                ${studentProgress.length > 0 ? studentProgress.map(s => {
                const baselineScore = s.baseline_score || 0;
                const midlineScore = s.midline_score || 0;
                const endlineScore = s.endline_score || 0;
                const improvement = endlineScore - baselineScore;

                return `
                                    <tr class="hover:bg-gray-700/50 transition">
                                        <td class="px-4 md:px-6 py-4 whitespace-nowrap">
                                            <div class="font-medium text-white">${s.name}</div>
                                            <div class="text-xs text-gray-400">Grade ${s.grade}</div>
                                        </td>
                                        <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm">
                                            <div class="font-medium ${baselineScore >= 70 ? 'text-green-400' : baselineScore >= 50 ? 'text-yellow-400' : 'text-red-400'}">${baselineScore}%</div>
                                        </td>
                                        <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm">
                                            <div class="font-medium ${midlineScore >= 70 ? 'text-green-400' : midlineScore >= 50 ? 'text-yellow-400' : 'text-red-400'}">${midlineScore}%</div>
                                        </td>
                                        <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm">
                                            <div class="font-medium ${endlineScore >= 70 ? 'text-green-400' : endlineScore >= 50 ? 'text-yellow-400' : 'text-red-400'}">${endlineScore}%</div>
                                        </td>
                                        <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm">
                                            <div class="font-bold ${improvement > 0 ? 'improvement-positive' : 'improvement-negative'}">${improvement > 0 ? '+' : ''}${improvement.toFixed(1)}%</div>
                                        </td>
                                        <td class="px-4 md:px-6 py-4 text-sm text-gray-300">
                                            ${improvement > 15 ? 'Excellent progress. Consider advanced materials.' :
                        improvement > 5 ? 'Good progress. Continue current approach.' :
                            improvement > 0 ? 'Moderate progress. Consider targeted support.' :
                                'Minimal progress. Needs intervention.'}
                                        </td>
                                    </tr>
                                    `;
            }).join('') : `
                                    <tr>
                                        <td colspan="6" class="px-4 md:px-6 py-8 text-center text-gray-400">
                                            <div class="flex flex-col items-center justify-center">
                                                <i data-lucide="clipboard-check" class="w-12 h-12 mb-2 text-gray-500"></i>
                                                <p>No assessment data available. Add students to see their progress.</p>
                                            </div>
                                        </td>
                                    </tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Initialize the student progress chart
            if (studentProgress.length > 0) {
                initializeStudentProgressChart(studentProgress);
            }
        }

        // =====================================================================
        // 5. FORM RENDERING & SUBMISSION
        // =====================================================================

        function showAddForm(type) {
            const formContainer = document.getElementById(type === 'student' ? 'add-student-form-container' : 'add-staff-form-container');
            const isHidden = formContainer.classList.contains('hidden');
            if (isHidden) {
                formContainer.classList.remove('hidden');
                formContainer.scrollIntoView({ behavior: 'smooth' });
            } else {
                formContainer.classList.add('hidden');
            }
        }

        function renderInput(name, label, type = 'text', required = true) {
            return `
                <div class="flex flex-col space-y-1">
                    <label for="${name}" class="text-xs font-medium text-gray-300">${label} ${required ? '<span class="text-red-500">*</span>' : ''}</label>
                    <input type="${type}" id="${name}" name="${name}" ${required ? 'required' : ''}
                        class="px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500 transition">
                </div>
            `;
        }

        function renderAddStudentForm() {
            return `
                <div id="add-student-form-container" class="hidden bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg mb-6 md:mb-8 border border-gray-700">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-400">Add New Student</h3>
                    <form onsubmit="handleCreate(event, 'student')" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        ${renderInput('name', 'Full Name')}
                        ${renderInput('grade', 'Grade Level (e.g., 9, 10)')}
                        ${renderInput('score', 'Overall Score (0-100)', 'number')}
                        ${renderInput('attendance', 'Attendance (%)', 'number')}
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white gradient-main rounded-lg hover:opacity-90 transition h-10 md:col-span-4">
                            Create Student
                        </button>
                    </form>
                </div>
            `;
        }

        function renderAddStaffForm() {
            return `
                <div id="add-staff-form-container" class="hidden bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg mb-6 md:mb-8 border border-gray-700">
                    <h3 class="text-xl font-semibold mb-4 text-purple-400">Add New Staff Member</h3>
                    <form onsubmit="handleCreate(event, 'staff')" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                        ${renderInput('name', 'Full Name')}
                        ${renderInput('role', 'Role (e.g., Teacher, Admin)')}
                        ${renderInput('department', 'Department (e.g., Science, Math)')}
                        <div class="md:col-span-2 lg:col-span-2">
                            <button type="submit" class="w-full px-4 py-2 text-sm font-medium text-white gradient-main rounded-lg hover:opacity-90 transition h-10">
                                Create Staff
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        async function handleCreate(event, type) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            // Create new item
            const newItem = {};
            for (let [key, value] of formData.entries()) {
                newItem[key] = value;
            }

            // Generate ID
            newItem.id = Date.now(); // Simple ID generation

            // Add to appropriate array
            if (type === 'student') {
                // Convert numeric values
                newItem.overall_score = parseInt(newItem.score) || 0;
                newItem.attendance = parseInt(newItem.attendance) || 0;
                delete newItem.score; // Remove temporary field

                appState.students.push(newItem);

                // Also add to student progress
                const baselineScore = Math.max(0, newItem.overall_score - 10 + Math.floor(Math.random() * 20));
                const midlineScore = Math.max(0, newItem.overall_score - 5 + Math.floor(Math.random() * 15));

                appState.assessments.studentProgress.push({
                    id: newItem.id,
                    name: newItem.name,
                    grade: newItem.grade,
                    baseline_score: baselineScore,
                    midline_score: midlineScore,
                    endline_score: newItem.overall_score
                });
            } else if (type === 'staff') {
                appState.staff.push(newItem);
            }

            // Save to localStorage
            saveAppState();

            showModal("Success!", `${newItem.name} has been added successfully.`);
            form.reset();

            // Refresh the data and view
            loadData();
        }

        async function handleDelete(type, id) {
            const itemType = type === 'student' ? 'Student' : 'Staff Member';
            const success = await showModal(
                "Confirm Deletion",
                `Are you sure you want to delete this ${itemType.toLowerCase()}? This action cannot be undone.`,
                true
            );

            if (!success) return;

            if (type === 'student') {
                appState.students = appState.students.filter(s => s.id !== id);
                appState.assessments.studentProgress = appState.assessments.studentProgress.filter(s => s.id !== id);
            } else if (type === 'staff') {
                appState.staff = appState.staff.filter(s => s.id !== id);
            }

            // Save to localStorage
            saveAppState();

            showModal("Success", `${itemType} deleted successfully.`);

            // Refresh the data and view
            loadData();
        }

        // =====================================================================
        // 6. CHART.JS INTEGRATION
        // =====================================================================

        let activeChart = null;

        function initializeChart(chartData, canvasId = 'average-scores-chart') {
            if (activeChart) {
                activeChart.destroy();
            }

            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            activeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: chartData.datasets[0].label,
                        data: chartData.datasets[0].data,
                        backgroundColor: chartData.datasets[0].backgroundColor,
                        borderColor: chartData.datasets[0].borderColor,
                        borderWidth: chartData.datasets[0].borderWidth,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#9ca3af' }, // gray-400
                            grid: { color: '#374151' } // gray-700
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        }

        function initializeStudentProgressChart(studentProgress) {
            const ctx = document.getElementById('student-progress-chart');
            if (!ctx) return;

            // Sample data - in a real app, this would come from the API
            const sampleStudents = studentProgress.slice(0, 5); // Show first 5 students
            const labels = ['Baseline', 'Midline', 'Endline'];

            const datasets = sampleStudents.map((student, index) => {
                const colors = ['#6366f1', '#8b5cf6', '#a855f7', '#ec4899', '#f59e0b'];
                return {
                    label: student.name,
                    data: [student.baseline_score || 0, student.midline_score || 0, student.endline_score || 0],
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20', // Add transparency
                    tension: 0.3,
                    fill: false
                };
            });

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#374151' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#9ca3af'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Student Progress Across Assessments',
                            color: '#e5e7eb'
                        }
                    }
                }
            });
        }

        // =====================================================================
        // 7. INITIALIZATION - FIXED
        // =====================================================================

        window.onload = function () {
            // Initialize Lucide icons
            lucide.createIcons();

            // Setup mobile menu
            setupMobileMenu();

            // Initialize app state from localStorage
            initializeAppState();

            // Set initial view and load data
            changeView('dashboard');

            // Initialize the active navigation state
            document.getElementById(`nav-${appState.currentView}`).classList.add('bg-indigo-700', 'text-white', 'main-shadow');
        };
    </script>
</body>

</html>